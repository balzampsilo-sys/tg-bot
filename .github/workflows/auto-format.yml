name: Auto Format Code

on:
  workflow_dispatch:
  push:
    branches:
      - fix-linting

jobs:
  format:
    name: Auto Format
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref || github.ref_name }}
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ðŸ“¦ Install formatting tools
      run: |
        python -m pip install --upgrade pip
        pip install black isort autoflake
    
    - name: ðŸ§¹ Run custom linting fixes
      run: |
        python fix_linting.py
    
    - name: ðŸ—‘ï¸ Remove unused imports with autoflake
      run: |
        autoflake --in-place --remove-all-unused-imports --remove-unused-variables \
          --ignore-init-module-imports --recursive . \
          --exclude venv,__pycache__,.git,htmlcov,.pytest_cache
    
    - name: ðŸ“„ Sort imports with isort
      run: |
        isort . --skip venv --skip __pycache__ --skip htmlcov --skip .pytest_cache
    
    - name: ðŸŽ¨ Format code with black
      run: |
        black . --exclude='venv|__pycache__|.git|htmlcov|.pytest_cache'
    
    - name: ðŸ“ Check for changes
      id: changes
      run: |
        if [[ -n $(git status -s) ]]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âœ… Code formatting changes detected"
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "âœ… No formatting changes needed"
        fi
    
    - name: ðŸ’¾ Commit changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .
        git commit -m "style: auto-format code with black, isort, and linting fixes
        
        - Fixed trailing whitespace (W291)
        - Fixed blank line whitespace (W293)
        - Fixed bare except statements (E722)
        - Removed unused imports (F401)
        - Fixed f-strings without placeholders (F541)
        - Formatted code with black
        - Sorted imports with isort"
        git push
    
    - name: ðŸ“Š Generate summary
      if: always()
      run: |
        echo "## ðŸŽ¨ Code Formatting Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
          echo "âœ… **Code has been automatically formatted**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Changes:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Trailing whitespace removed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Blank lines cleaned" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Bare except statements fixed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Unused imports removed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code formatted with black" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Imports sorted with isort" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **No formatting changes needed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Code is already properly formatted!" >> $GITHUB_STEP_SUMMARY
        fi
