name: Auto Format Code

on:
  workflow_dispatch:
  push:
    branches:
      - fix-linting

jobs:
  format:
    name: Auto Format
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref || github.ref_name }}
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ðŸ“¦ Install formatting tools
      run: |
        python -m pip install --upgrade pip
        pip install black isort autoflake flake8
    
    - name: ðŸ” Check Python syntax
      id: syntax_check
      run: |
        echo "Checking Python syntax..."
        python -m py_compile $(find . -name '*.py' -not -path './venv/*' -not -path './__pycache__/*' -not -path './htmlcov/*' -not -path './.pytest_cache/*') 2>&1 | tee syntax_errors.txt || true
        if [ -s syntax_errors.txt ]; then
          echo "has_syntax_errors=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ Syntax errors found!"
          cat syntax_errors.txt
        else
          echo "has_syntax_errors=false" >> $GITHUB_OUTPUT
          echo "âœ… No syntax errors"
        fi
      continue-on-error: true
    
    - name: ðŸ§¹ Run custom linting fixes
      run: |
        echo "Running custom linting fixes..."
        python fix_linting.py || echo "âš ï¸ Some files couldn't be fixed automatically"
      continue-on-error: true
    
    - name: ðŸ—‘ï¸ Remove unused imports with autoflake
      run: |
        echo "Removing unused imports..."
        autoflake --in-place --remove-all-unused-imports --remove-unused-variables \
          --ignore-init-module-imports --recursive . \
          --exclude venv,__pycache__,.git,htmlcov,.pytest_cache 2>&1 || echo "âš ï¸ autoflake had issues with some files"
      continue-on-error: true
    
    - name: ðŸ“„ Sort imports with isort
      run: |
        echo "Sorting imports..."
        isort . --skip venv --skip __pycache__ --skip htmlcov --skip .pytest_cache 2>&1 || echo "âš ï¸ isort had issues with some files"
      continue-on-error: true
    
    - name: ðŸŽ¨ Format code with black
      run: |
        echo "Formatting code with black..."
        black . --exclude='venv|__pycache__|.git|htmlcov|.pytest_cache' 2>&1 | tee black_output.txt || true
        
        if grep -q "failed to reformat" black_output.txt; then
          echo "âš ï¸ Black couldn't format some files (syntax errors?)"
          grep "failed to reformat" black_output.txt || true
        fi
        
        if grep -q "reformatted" black_output.txt; then
          echo "âœ… Black successfully formatted files"
        fi
      continue-on-error: true
    
    - name: ðŸ“ Check for changes
      id: changes
      run: |
        if [[ -n $(git status -s) ]]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âœ… Code formatting changes detected"
          echo "Changed files:"
          git status -s
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "âœ… No formatting changes needed"
        fi
    
    - name: ðŸ’¾ Commit changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .
        git commit -m "style: auto-format code with black, isort, and linting fixes
        
        - Fixed trailing whitespace (W291)
        - Fixed blank line whitespace (W293)
        - Fixed bare except statements (E722)
        - Removed unused imports (F401)
        - Fixed f-strings without placeholders (F541)
        - Formatted code with black
        - Sorted imports with isort
        
        Note: Some files may have been skipped due to syntax errors."
        git push
    
    - name: ðŸ“Š Generate summary
      if: always()
      run: |
        echo "## ðŸŽ¨ Code Formatting Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.syntax_check.outputs.has_syntax_errors }}" == "true" ]; then
          echo "âš ï¸ **Warning: Some files have syntax errors**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "These files were skipped during formatting." >> $GITHUB_STEP_SUMMARY
          echo "Please fix syntax errors manually." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
          echo "âœ… **Code has been automatically formatted**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Changes:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Trailing whitespace removed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Blank lines cleaned" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Bare except statements fixed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Unused imports removed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code formatted with black" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Imports sorted with isort" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed files:" >> $GITHUB_STEP_SUMMARY
          git diff --name-only HEAD^ HEAD 2>/dev/null | while read file; do
            echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
          done || echo "(run manually to see changes)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **No formatting changes needed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Code is already properly formatted!" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ **Tip:** Files with syntax errors must be fixed manually before they can be formatted." >> $GITHUB_STEP_SUMMARY
