# üß™ –¢–µ—Å—Ç—ã

–≠—Ç–∞ –ø–∞–ø–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç unit-—Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ tg-bot.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements-test.txt
```

### –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤

```bash
# –ò–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
pytest

# –° –¥–µ—Ç–∞–ª—å–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
pytest -v

# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
pytest --cov=. --cov-report=html
```

### –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Ç–µ—Å—Ç–æ–≤

```bash
pytest tests/test_booking_service.py -v
```

### –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞

```bash
pytest tests/test_booking_service.py::TestCreateBooking::test_create_booking_success -v
```

## üìù –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```
tests/
‚îú‚îÄ‚îÄ conftest.py              # –û–±—â–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã pytest
‚îú‚îÄ‚îÄ test_booking_service.py  # –¢–µ—Å—Ç—ã BookingService
‚îî‚îÄ‚îÄ README.md                # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## üß∞ –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è

### ‚úÖ TestCreateBooking
- –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏
- –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω—è—Ç—ã–π —Å–ª–æ—Ç
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –∑–∞–ø–∏—Å–µ–π (MAX_BOOKINGS_PER_USER)
- **üî¥ Race condition** - –¥–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—ã—Ç–∞—é—Ç—Å—è –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –æ–¥–∏–Ω —Å–ª–æ—Ç

### üîÑ TestRescheduleBooking
- –£—Å–ø–µ—à–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–∏
- **üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô:** –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞ –∑–∞–Ω—è—Ç—ã–π —Å–ª–æ—Ç (—Å—Ç–∞—Ä–∞—è –∑–∞–ø–∏—Å—å –ù–ï –¥–æ–ª–∂–Ω–∞ —É–¥–∞–ª–∏—Ç—å—Å—è!)
- –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å

### ‚ùå TestCancelBooking
- –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏
- –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–º–µ–Ω–∏—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å

### üîí TestAtomicity
- **üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô:** –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–Ω–æ—Å–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è UPDATE, –∞ –Ω–µ DELETE+INSERT)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ ID –∑–∞–ø–∏—Å–∏ –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è

### üíæ TestDatabaseMethods
- get_booking_by_id()
- cleanup_old_bookings()
- get_all_users()

## üéØ –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ —Å `--cov-report=html`, –æ—Ç–∫—Ä–æ–π—Ç–µ:

```bash
open htmlcov/index.html  # macOS
xdg-open htmlcov/index.html  # Linux
start htmlcov/index.html  # Windows
```

## ‚öôÔ∏è GitHub Actions

–¢–µ—Å—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–∏:
- –ö–∞–∂–¥–æ–º push –≤ `main` –∏–ª–∏ `develop`
- –ö–∞–∂–¥–æ–º Pull Request
- –í—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ Actions –≤–∫–ª–∞–¥–∫—É

–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: [Actions](https://github.com/balzampsilo-sys/tg-bot/actions)

## üìä CI/CD Pipeline

Workflow –≤–∫–ª—é—á–∞–µ—Ç 3 –∑–∞–¥–∞—á–∏:

1. **üß™ Tests** - –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –Ω–∞ Python 3.10 –∏ 3.11
2. **üßΩ Lint** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ (flake8, black, isort)
3. **üîí Security** - —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π (bandit)

## üõ†Ô∏è –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤

1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `test_<component>.py`
2. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ pytest –∏ —Ñ–∏–∫—Å—Ç—É—Ä—ã
3. –°–æ–∑–¥–∞–π—Ç–µ –∫–ª–∞—Å—Å—ã —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `Test`
4. –ù–∞–ø–∏—à–∏—Ç–µ –º–µ—Ç–æ–¥—ã —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `test_`
5. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `@pytest.mark.asyncio` –¥–ª—è async —Ñ—É–Ω–∫—Ü–∏–π

–ü—Ä–∏–º–µ—Ä:

```python
import pytest
from mymodule import MyClass

@pytest.mark.asyncio
async def test_my_function():
    result = await MyClass().my_method()
    assert result == expected_value
```

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [pytest –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://docs.pytest.org/)
- [pytest-asyncio](https://pytest-asyncio.readthedocs.io/)
- [pytest-cov](https://pytest-cov.readthedocs.io/)
- [GitHub Actions](https://docs.github.com/en/actions)

## ‚ùì –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

**Q: –¢–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç —Å –æ—à–∏–±–∫–æ–π "ModuleNotFoundError"**

A: –ó–∞–ø—É—Å–∫–∞–π—Ç–µ pytest –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞, –Ω–µ –∏–∑ –ø–∞–ø–∫–∏ tests/

**Q: –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã?**

A: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –∏–º–µ–Ω–∏:
```bash
pytest -k "reschedule_to_taken" -v
```

**Q: –ö–∞–∫ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã GitHub Actions?**

A: –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ GitHub ‚Üí –≤–∫–ª–∞–¥–∫–∞ "Actions" ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ workflow "Tests"
