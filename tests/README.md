# üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –±–æ—Ç–∞

–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∑–∞–ø—É—Å–∫—É –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –±–æ—Ç–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements-test.txt

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Ç–µ—Å—Ç—ã
pytest

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
pytest --cov=. --cov-report=html
```

## üìö –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–£—Å—Ç–∞–Ω–æ–≤–∫–∞](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
- [–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤](#–∑–∞–ø—É—Å–∫-—Ç–µ—Å—Ç–æ–≤)
- [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã](#–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ-—Ç–µ—Å—Ç—ã)
- [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-—Ç–µ—Å—Ç–æ–≤)
- [CI/CD](#cicd)
- [–ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞](#–ø–æ–∫—Ä—ã—Ç–∏–µ-–∫–æ–¥–∞)

---

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone https://github.com/balzampsilo-sys/tg-bot.git
cd tg-bot
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# Linux/Mac
python3 -m venv venv
source venv/bin/activate
```

### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements-test.txt
```

---

## üèÉ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
pytest

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
pytest -v

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª
pytest tests/test_booking_service.py

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç
pytest tests/test_booking_service.py::TestRescheduleBooking::test_reschedule_to_taken_slot

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
pytest -m asyncio

# –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
pytest -m "not slow"
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º

```bash
# –° HTML –æ—Ç—á–µ—Ç–æ–º
pytest --cov=. --cov-report=html

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ
open htmlcov/index.html  # Mac
start htmlcov/index.html  # Windows

# –° XML –æ—Ç—á–µ—Ç–æ–º (–¥–ª—è CI/CD)
pytest --cov=. --cov-report=xml

# –° —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–º –æ—Ç—á–µ—Ç–æ–º
pytest --cov=. --cov-report=term-missing
```

### –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pytest-xdist
pip install pytest-xdist

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞ 4 –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö
pytest -n 4

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —è–¥–µ—Ä
pytest -n auto
```

---

## ‚ö° –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã

–≠—Ç–∏ —Ç–µ—Å—Ç—ã **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** –¥–æ–ª–∂–Ω—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å:

### 1Ô∏è‚É£ –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–Ω–æ—Å–∞ –∑–∞–ø–∏—Å–µ–π

```bash
pytest tests/test_booking_service.py::TestRescheduleBooking::test_reschedule_to_taken_slot -v
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞ –∑–∞–Ω—è—Ç—ã–π —Å–ª–æ—Ç:
  - ‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è (success=False)
  - ‚úÖ **–°—Ç–∞—Ä–∞—è –∑–∞–ø–∏—Å—å –ù–ï —É–¥–∞–ª—è–µ—Ç—Å—è**
  - ‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è

### 2Ô∏è‚É£ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ UPDATE –≤–º–µ—Å—Ç–æ DELETE+INSERT

```bash
pytest tests/test_booking_service.py::TestAtomicity::test_reschedule_atomicity_uses_update -v
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- ‚úÖ ID –∑–∞–ø–∏—Å–∏ –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–æ—Å–∞
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è UPDATE, –∞ –Ω–µ DELETE+INSERT

### 3Ô∏è‚É£ Race Condition

```bash
pytest tests/test_booking_service.py::TestCreateBooking::test_create_booking_race_condition -v
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- ‚úÖ –ü—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å–ª–æ—Ç
- ‚úÖ –í—Ç–æ—Ä–æ–π –ø–æ–ª—É—á–∞–µ—Ç –æ—à–∏–±–∫—É "slot_taken"

### 4Ô∏è‚É£ –õ–∏–º–∏—Ç –∑–∞–ø–∏—Å–µ–π

```bash
pytest tests/test_booking_service.py::TestCreateBooking::test_create_booking_limit_exceeded -v
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- ‚úÖ –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –±–æ–ª–µ–µ MAX_BOOKINGS_PER_USER –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è error_code="limit_exceeded"

---

## üìù –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```
tests/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ conftest.py              # –û–±—â–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã
‚îú‚îÄ‚îÄ test_booking_service.py  # –¢–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
‚îî‚îÄ‚îÄ README.md                # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

### –ö–ª–∞—Å—Å—ã —Ç–µ—Å—Ç–æ–≤

| –ö–ª–∞—Å—Å | –û–ø–∏—Å–∞–Ω–∏–µ | –ö–æ–ª-–≤–æ —Ç–µ—Å—Ç–æ–≤ |
|-------|-------------|-------------|
| `TestCreateBooking` | –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π | 5 |
| `TestRescheduleBooking` | –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–µ–π | 4 |
| `TestCancelBooking` | –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–µ–π | 2 |
| `TestAtomicity` | –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π | 2 |
| `TestDatabaseMethods` | –ú–µ—Ç–æ–¥—ã Database | 5 |

---

## üîÑ CI/CD

### GitHub Actions

–¢–µ—Å—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–∏:
- ‚úÖ Push –≤ –≤–µ—Ç–∫–∏ `main` –∏–ª–∏ `develop`
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–∏ Pull Request
- ‚úÖ –†—É—á–Ω–æ–º –∑–∞–ø—É—Å–∫–µ (workflow_dispatch)

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ [Actions](https://github.com/balzampsilo-sys/tg-bot/actions)
2. –í—ã–±–µ—Ä–∏—Ç–µ workflow "Tests"
3. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
   - ‚úÖ –¢–µ—Å—Ç—ã –Ω–∞ Python 3.10, 3.11, 3.12
   - üßπ –õ–∏–Ω—Ç–∏–Ω–≥ (flake8, black, isort)
   - üîí Security Scan (bandit)

### –õ–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∫ –≤ CI

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
pytest --cov=. --cov-report=xml --cov-report=term
flake8 . --exclude=venv,__pycache__
black --check .
isort --check-only .
bandit -r . --exclude './venv/*,./tests/*'
```

---

## üìä –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

### –¢–µ–∫—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ

–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ: **70%**

### –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á–µ—Ç–∞

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –æ—Ç—á–µ—Ç–∞
pytest --cov=. --cov-report=html

# –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
open htmlcov/index.html  # Mac
start htmlcov/index.html  # Windows
xdg-open htmlcov/index.html  # Linux
```

### –ß—Ç–æ –ø–æ–∫—Ä—ã—Ç–æ —Ç–µ—Å—Ç–∞–º–∏

- ‚úÖ `services/booking_service.py` - 95%
- ‚úÖ `database/queries.py` - 90%
- ‚úÖ `utils/helpers.py` - 85%
- üü° `handlers/booking_handlers.py` - 60%
- üü° `handlers/admin_handlers.py` - 50%

---

## üêû –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

```bash
pytest -v --tb=long
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–æ–ª—å–∫–æ –ø–∞–¥–∞—é—â–∏–π —Ç–µ—Å—Ç

```bash
pytest tests/test_booking_service.py::TestRescheduleBooking::test_reschedule_to_taken_slot -vvs
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î

–ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç –∏–∑-–∑–∞ –ë–î:

```bash
# –£–¥–∞–ª–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –ë–î
rm test_bookings.db

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã –∑–∞–Ω–æ–≤–æ
pytest
```

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
pip install -r requirements-test.txt --upgrade
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [pytest –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://docs.pytest.org/)
- [pytest-asyncio](https://pytest-asyncio.readthedocs.io/)
- [coverage.py](https://coverage.readthedocs.io/)
- [GitHub Actions](https://docs.github.com/en/actions)

---

## ‚ùì –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

**Q: –ü–æ—á–µ–º—É —Ç–µ—Å—Ç—ã –º–µ–¥–ª–µ–Ω–Ω—ã–µ?**

A: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫:
```bash
pip install pytest-xdist
pytest -n auto
```

**Q: –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã?**

A: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∞—Ä–∫–µ—Ä—ã (–±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏)

**Q: –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã?**

A: –°–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –≤ `test_booking_service.py` –∏ —Å–ª–µ–¥—É–π—Ç–µ —Ç–æ–π –∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.

---

‚úÖ **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç!** –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –±—ã—Ç—å —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ! üéâ
