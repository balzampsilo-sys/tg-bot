# üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–í —ç—Ç–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–Ω–µ—Å–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:

1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ race condition** –≤ `reschedule_booking` - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
2. **–î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π** - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î
3. **Persistent FSM storage** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ
4. **–£–ª—É—á—à–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å timezone** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ DST

## üìù –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–æ—Ç–∞
pkill -f "python main.py"

# –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
cp bookings.db bookings.db.backup_$(date +%Y%m%d_%H%M%S)
```

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥

```bash
# –°–∫–∞—á–∞–π—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git pull origin main
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –ë–î

```bash
python migrate.py current
```

–í—ã —É–≤–∏–¥–∏—Ç–µ —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ:
```
üìä Current database version: 0
üéØ Latest available version: 2

‚ö†Ô∏è  Database needs migration (0 -> 2)
Run: python migrate.py migrate
```

### –®–∞–≥ 4: –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
python migrate.py migrate
```

–í—ã —É–≤–∏–¥–∏—Ç–µ:
```
Applying migration 1: Initial database schema with all tables and indexes
Migration 1 applied successfully
Applying migration 2: Add version column for optimistic locking in bookings
Migration 2 applied successfully

‚úÖ Migration completed! Current version: 2
```

### –®–∞–≥ 5: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞

```bash
python main.py
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
‚úÖ Database migrations completed
üöÄ Bot started with persistent storage
```

## üß∞ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

–ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è —É–ø–∞–ª–∞ —Å –æ—à–∏–±–∫–æ–π:

```bash
# 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±—ç–∫–∞–ø
cp bookings.db.backup_YYYYMMDD_HHMMSS bookings.db

# 2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑
python migrate.py migrate

# 3. –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ - —Å–æ–æ–±—â–∏—Ç–µ –æ–± –æ—à–∏–±–∫–µ
```

### –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
python main.py

# –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –∏–º–ø–æ—Ä—Ç–∞–º–∏:
pip install -r requirements.txt --upgrade
```

### –ü–æ—Ç–µ—Ä—è–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM

–°–æ—Å—Ç–æ—è–Ω–∏—è —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `fsm_storage.db`. –ï—Å–ª–∏ —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω:

```bash
# –û–Ω —Å–æ–∑–¥–∞—Å—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
python main.py
```

## üîÑ –û—Ç–∫–∞—Ç –Ω–∞–∑–∞–¥

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è:

### –ü–æ–ª–Ω—ã–π –æ—Ç–∫–∞—Ç

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–æ—Ç–∞
pkill -f "python main.py"

# –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∫–æ–¥–∞
git checkout HEAD~1

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±—ç–∫–∞–ø –ë–î
cp bookings.db.backup_YYYYMMDD_HHMMSS bookings.db

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞
python main.py
```

### –û—Ç–∫–∞—Ç —Ç–æ–ª—å–∫–æ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
# –û—Ç–∫–∞—Ç–∏—Ç—å—Å—è –¥–æ –≤–µ—Ä—Å–∏–∏ 0 (–∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
python migrate.py rollback 0
```

**–í–ù–ò–ú–ê–ù–ò–ï**: –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π —É–¥–∞–ª–∏—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—É—é –∫–æ–ª–æ–Ω–∫—É `version`. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–≤–µ—Ä–µ–Ω—ã.

## üì¶ –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã:

```
‚îú‚îÄ‚îÄ fsm_storage.db           # FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è (—Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
‚îú‚îÄ‚îÄ CHANGELOG.md            # –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚îú‚îÄ‚îÄ UPGRADE_GUIDE.md        # –≠—Ç–æ—Ç —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ migrate.py              # CLI –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ datetime_utils.py    # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏
‚îÇ   ‚îî‚îÄ‚îÄ sqlite_storage.py    # SQLite FSM storage
‚îî‚îÄ‚îÄ database/
    ‚îî‚îÄ‚îÄ migrations/          # –°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π
        ‚îú‚îÄ‚îÄ migration_manager.py
        ‚îî‚îÄ‚îÄ versions/
            ‚îú‚îÄ‚îÄ v001_initial_schema.py
            ‚îî‚îÄ‚îÄ v002_add_version_column.py
```

### –î–æ–±–∞–≤—å—Ç–µ –≤ .gitignore

```bash
echo "fsm_storage.db" >> .gitignore
echo "bookings.db.backup_*" >> .gitignore
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–Ω–æ—Å**: –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ FSM**: –ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ –¥–∏–∞–ª–æ–≥
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥–º–∏–Ω–∫—É**: –û—Ç–∫—Ä–æ–π—Ç–µ /admin –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏

## üë• –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `CHANGELOG.md` - –≤–æ–∑–º–æ–∂–Ω–æ, –≤–∞—à–∞ –ø—Ä–æ–±–ª–µ–º–∞ —É–∂–µ –æ–ø–∏—Å–∞–Ω–∞
2. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞ - –æ–Ω–∏ —Å—Ç–∞–ª–∏ –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏
3. –°–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

---

**–í–∞–∂–Ω–æ**: –≠—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ –∏ –Ω–µ –¥–æ–ª–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º. –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.
